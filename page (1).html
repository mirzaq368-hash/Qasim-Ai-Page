<p></p>
<!-- Font Awesome for Icons -->
<p></p>
<div class="app-container">
<div class="header"><span><i class="fa-solid fa-wand-magic-sparkles"></i> Qasim AI</span> <i class="fa-solid fa-circle-info" style="font-size: 1rem; opacity: 0.5;"></i></div>
<div id="chat-box">
<div class="message ai-message">Assalam-o-Alaikum! Main <strong>Qasim AI</strong> hun. <br />Aap mujhse sawal pooch sakte hain, photo dikha sakte hain, ya voice command de sakte hain.</div>
</div>
<div class="typing" id="loader"><i class="fa-solid fa-spinner fa-spin"></i> ✨ Qasim AI Soch raha hai...</div>
<div id="preview-box"><img id="img-preview" />
<div class="close-preview" onclick="clearImg()">&times;</div>
</div>
<div class="ai-tools"><button class="tool-btn" onclick="quickAction('Explain ✨')">Explain ✨</button> <button class="tool-btn" onclick="quickAction('Summarize ✨')">Summarize ✨</button> <button class="tool-btn" onclick="quickAction('Translate to Urdu ✨')">Translate ✨</button> <button class="tool-btn" onclick="quickAction('Write a Poem ✨')">Poem ✨</button></div>
<div class="input-area">
<div class="input-wrapper"><label for="file-up" class="icon-btn"><i class="fa-solid fa-camera"></i></label> <input type="file" id="file-up" accept="image/*" hidden="" onchange="previewFile(event)" /> <input type="text" id="user-input" placeholder="Yahan likhein ya bolein..." onkeypress="if(event.key==='Enter') startProcess()" /> <button id="mic-btn" class="icon-btn" onclick="toggleMic()"> <i class="fa-solid fa-microphone"></i> </button></div>
<button id="send-btn" onclick="startProcess()"> <i class="fa-solid fa-paper-plane"></i> </button></div>
</div>
<script>
    // --- API Configuration ---
    const apiKey = ""; // Environment handles this
    const modelName = "gemini-2.5-flash-preview-09-2025";

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const loader = document.getElementById('loader');
    const micBtn = document.getElementById('mic-btn');
    const previewBox = document.getElementById('preview-box');
    const imgPreview = document.getElementById('img-preview');
    
    let base64Img = null;
    let isRec = false;

    // --- Speech Recognition ---
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (Speech) {
        recognition = new Speech();
        recognition.lang = 'ur-PK';
        recognition.onresult = (e) => {
            userInput.value = e.results[0][0].transcript;
            startProcess();
        };
        recognition.onend = () => { isRec = false; micBtn.classList.remove('recording'); };
    }

    function toggleMic() {
        if (!recognition) return alert("Browser support nahi karta");
        if (isRec) { recognition.stop(); } 
        else { recognition.start(); isRec = true; micBtn.classList.add('recording'); }
    }

    // --- Image Logic ---
    function previewFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (f) => {
            base64Img = f.target.result.split(',')[1];
            imgPreview.src = f.target.result;
            previewBox.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function clearImg() {
        base64Img = null;
        previewBox.style.display = 'none';
        document.getElementById('file-up').value = '';
    }

    function append(txt, sender, img = null) {
        const d = document.createElement('div');
        d.className = `message ${sender}-message`;
        let html = txt.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        if (img) html = `<img src="data:image/jpeg;base64,${img}"><br>` + html;
        d.innerHTML = html;
        chatBox.appendChild(d);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function quickAction(type) {
        if (!userInput.value && !base64Img) {
            userInput.value = type + ": ";
            userInput.focus();
        } else {
            userInput.value = type + " this: " + userInput.value;
            startProcess();
        }
    }

    // --- Gemini API Call with Retry Logic ---
    async function startProcess() {
        const val = userInput.value.trim();
        if (!val && !base64Img) return;

        const currentImg = base64Img;
        append(val || "Photo analysis request", 'user', currentImg);
        
        userInput.value = '';
        clearImg();
        loader.style.display = 'block';

        const systemPrompt = "You are Qasim AI. Helpful, creative, and professional. Reply in Roman Urdu/Hindi. If user asks to analyze image, be very descriptive.";
        
        const payload = {
            contents: [{
                parts: [
                    { text: val || "Describe this image in detail." }
                ]
            }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };

        if (currentImg) {
            payload.contents[0].parts.push({
                inlineData: { mimeType: "image/png", data: currentImg }
            });
        }

        // Exponential Backoff Implementation
        let retryCount = 0;
        const maxRetries = 5;
        
        async function makeRequest() {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                const aiTxt = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf kijiyega, samajh nahi paya.";
                
                loader.style.display = 'none';
                append(aiTxt, 'ai');
                speak(aiTxt);

            } catch (err) {
                if (retryCount < maxRetries) {
                    retryCount++;
                    const delay = Math.pow(2, retryCount) * 500;
                    setTimeout(makeRequest, delay);
                } else {
                    loader.style.display = 'none';
                    append("Server busy hai, please thodi der baad try karein.", 'ai');
                }
            }
        }

        makeRequest();
    }

    function speak(t) {
        const clean = t.replace(/\*/g, '');
        const utter = new SpeechSynthesisUtterance(clean);
        const voices = window.speechSynthesis.getVoices();
        // Try to pick a South Asian sounding voice if available
        utter.voice = voices.find(v => v.lang.includes('hi') || v.lang.includes('ur')) || voices[0];
        utter.rate = 1.1;
        window.speechSynthesis.speak(utter);
    }
</script>